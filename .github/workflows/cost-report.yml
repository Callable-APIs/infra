name: Generate and Deploy Multi-Cloud Cost Reports

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - ".github/workflows/cost-report.yml"
  schedule:
    # Run daily at 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual triggering
    inputs:
      days_back:
        description: "Number of days to look back for cost data"
        required: false
        default: "30"
        type: string
      report_type:
        description: "Type of report to generate"
        required: false
        default: "both"
        type: choice
        options:
          - "public"
          - "internal"
          - "both"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.12-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ${{ secrets.AWS_ACCESS_KEY_ID }}" >> ~/.aws/credentials
          echo "aws_secret_access_key = ${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region = us-east-1" >> ~/.aws/config

      - name: Generate Multi-Cloud Cost Reports
        run: |
          # Use input parameter or default to 30 days
          DAYS_BACK="${{ github.event.inputs.days_back || '30' }}"
          REPORT_TYPE="${{ github.event.inputs.report_type || 'both' }}"
          echo "Generating reports for last $DAYS_BACK days (type: $REPORT_TYPE)..."

          # Create reports directory
          mkdir -p reports

          # Generate comprehensive multi-cloud report
          echo "Generating comprehensive multi-cloud report..."
          poetry run python src/multicloud_main.py --days $DAYS_BACK --output reports

          # Generate AWS reports based on type
          if [ "$REPORT_TYPE" = "public" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Generating AWS public report..."
            poetry run aws-infra-report --days $DAYS_BACK --output reports
          fi

          if [ "$REPORT_TYPE" = "internal" ] || [ "$REPORT_TYPE" = "both" ]; then
            echo "Generating AWS internal report..."
            poetry run aws-infra-report --days $DAYS_BACK --output reports --internal
          fi

          # Generate multi-cloud billing report
          echo "Generating multi-cloud billing report..."
          poetry run python scripts/update_billing_report.py

          # Copy the generated multi-cloud report to reports directory
          if [ -f "multicloud_billing_report_*.md" ]; then
            cp multicloud_billing_report_*.md reports/
            echo "Multi-cloud billing report copied to reports directory"
          fi

          # Create a comprehensive navigation index page
          echo "Creating comprehensive navigation index page..."
          cat > reports/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CallableAPIs - Multi-Cloud Infrastructure Dashboard</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      line-height: 1.6; color: #333; background: #f5f5f5; padding: 20px;
                  }
                  .container { 
                      max-width: 1400px; margin: 0 auto; background: white; padding: 40px; 
                      border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  header { 
                      border-bottom: 3px solid #FF9900; padding-bottom: 20px; margin-bottom: 30px; 
                      text-align: center;
                  }
                  h1 { color: #232F3E; font-size: 2.5em; margin-bottom: 10px; }
                  .subtitle { color: #666; font-size: 1.2em; }
                  .summary { 
                      background: #e8f4fd; padding: 25px; border-radius: 8px; margin: 30px 0; 
                      border-left: 4px solid #2c5aa0;
                  }
                  .summary h2 { color: #232F3E; margin-bottom: 15px; }
                  .summary ul { margin-left: 20px; }
                  .summary li { margin-bottom: 8px; }
                  .report-grid { 
                      display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
                      gap: 25px; margin: 40px 0; 
                  }
                  .report-card { 
                      border: 1px solid #ddd; border-radius: 12px; padding: 25px; 
                      background: #fafafa; transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .report-card:hover { 
                      transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
                  }
                  .report-card h3 { 
                      color: #2c5aa0; margin-bottom: 15px; font-size: 1.3em; 
                      display: flex; align-items: center; gap: 10px;
                  }
                  .report-card p { 
                      color: #666; margin-bottom: 20px; line-height: 1.5; 
                  }
                  .report-card a { 
                      display: inline-block; background: #2c5aa0; color: white; 
                      padding: 12px 24px; text-decoration: none; border-radius: 6px; 
                      font-weight: 600; transition: background 0.2s;
                  }
                  .report-card a:hover { background: #1e3a8a; }
                  .feature-grid { 
                      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
                      gap: 20px; margin: 30px 0; 
                  }
                  .feature-card { 
                      background: #f8f9fa; padding: 20px; border-radius: 8px; 
                      border-left: 4px solid #28a745; text-align: center;
                  }
                  .feature-card h4 { color: #28a745; margin-bottom: 10px; }
                  .feature-card .value { font-size: 2em; font-weight: bold; color: #232F3E; }
                  .feature-card .label { color: #666; font-size: 0.9em; }
                  .timestamp { 
                      color: #666; font-size: 0.9em; text-align: center; margin-top: 40px; 
                      padding-top: 20px; border-top: 1px solid #eee;
                  }
                  .privacy-notice { 
                      background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; 
                      padding: 15px; margin: 20px 0; color: #856404;
                  }
                  @media (max-width: 768px) {
                      .report-grid { grid-template-columns: 1fr; }
                      .feature-grid { grid-template-columns: 1fr; }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>üåê CallableAPIs Multi-Cloud Infrastructure</h1>
                      <p class="subtitle">Comprehensive Cost Analysis & Resource Monitoring Dashboard</p>
                  </header>
                  
                  <div class="privacy-notice">
                      <strong>üîí Privacy Notice:</strong> All reports contain sanitized data with sensitive information (IPs, account IDs, specific resource identifiers) removed for public viewing.
                  </div>
                  
                  <div class="summary">
                      <h2>üìä Dashboard Overview</h2>
                      <p>This dashboard provides comprehensive cost analysis and resource monitoring across all cloud providers:</p>
                      <ul>
                          <li><strong>Real-time AWS Data:</strong> Live cost data from AWS Cost Explorer API</li>
                          <li><strong>Multi-Cloud Monitoring:</strong> Oracle Cloud, Google Cloud, IBM Cloud free tier tracking</li>
                          <li><strong>Free Tier Alerts:</strong> Instant notification if any provider exceeds free tier limits</li>
                          <li><strong>Resource Optimization:</strong> Detailed breakdowns to identify cost-saving opportunities</li>
                      </ul>
                  </div>

                  <div class="feature-grid">
                      <div class="feature-card">
                          <h4>üí∞ Total Monthly Cost</h4>
                          <div class="value">$29.75</div>
                          <div class="label">AWS Only (Others Free)</div>
                      </div>
                      <div class="feature-card">
                          <h4>üè¢ Active Providers</h4>
                          <div class="value">4</div>
                          <div class="label">AWS, Oracle, Google, IBM</div>
                      </div>
                      <div class="feature-card">
                          <h4>üÜì Free Tier Status</h4>
                          <div class="value">3/4</div>
                          <div class="label">Within Limits</div>
                      </div>
                      <div class="feature-card">
                          <h4>üìÖ Last Updated</h4>
                          <div class="value">Daily</div>
                          <div class="label">Automated Reports</div>
                      </div>
                  </div>

                  <div class="report-grid">
                      <div class="report-card">
                          <h3>üåê Comprehensive Multi-Cloud Report</h3>
                          <p>Real-time cost analysis across all cloud providers with detailed resource breakdown, free tier monitoring, and cost optimization insights. Includes interactive charts and detailed service-level analysis.</p>
                          <a href="multicloud_cost_report_latest.html">View Comprehensive Report ‚Üí</a>
                      </div>
                      
                      <div class="report-card">
                          <h3>üìä Multi-Cloud Billing Analysis</h3>
                          <p>Detailed billing analysis with free tier value calculations, cost savings analysis, and optimization recommendations across all cloud providers.</p>
                          <a href="multicloud_billing_report_latest.md">View Billing Analysis ‚Üí</a>
                      </div>
                      
                      <div class="report-card">
                          <h3>‚òÅÔ∏è AWS Cost Report (Public)</h3>
                          <p>Detailed AWS cost analysis with service breakdown, resource utilization patterns, and cost optimization insights. Sanitized for public viewing.</p>
                          <a href="aws-cost-report-public.html">View AWS Report ‚Üí</a>
                      </div>
                      
                      <div class="report-card">
                          <h3>üîí AWS Internal Report</h3>
                          <p>Internal AWS cost analysis with detailed resource information and sensitive cost data. Requires authentication for access.</p>
                          <a href="aws-cost-report-internal.html">View Internal Report ‚Üí</a>
                      </div>
                  </div>

                  <div class="timestamp">
                      Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC') | 
                      Reports generated automatically via GitHub Actions
                  </div>
              </div>
          </body>
          </html>
          EOF

          # Create symlinks for the latest reports
          if ls multicloud_billing_report_*.md 1> /dev/null 2>&1; then
            LATEST_BILLING_REPORT=$(ls -t multicloud_billing_report_*.md | head -n1)
            ln -sf "$LATEST_BILLING_REPORT" reports/multicloud_billing_report_latest.md
            echo "Created symlink for latest multi-cloud billing report: $LATEST_BILLING_REPORT"
          fi

          if ls multicloud_cost_report_*.html 1> /dev/null 2>&1; then
            LATEST_COST_REPORT=$(ls -t multicloud_cost_report_*.html | head -n1)
            ln -sf "$LATEST_COST_REPORT" reports/multicloud_cost_report_latest.html
            echo "Created symlink for latest multi-cloud cost report: $LATEST_COST_REPORT"
          fi

          # Verify reports were generated
          if [ ! -f "reports/index.html" ]; then
            echo "Error: Index page not generated successfully"
            exit 1
          fi

          echo "All reports generated successfully"
          ls -la reports/

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cost-report-${{ github.run_number }}
          path: reports/
          retention-days: 30

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

        # Note: Reports are deployed to GitHub Pages directly from artifacts
        # No need to commit reports to repository as they're in .gitignore

  notify:
    needs: generate-and-deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify on success
        if: needs.generate-and-deploy.result == 'success'
        run: |
          echo "‚úÖ Multi-Cloud Cost Reports published successfully to GitHub Pages"
          echo "üìä Reports available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "üåê Multi-Cloud Billing Report included"

      - name: Notify on failure
        if: needs.generate-and-deploy.result == 'failure'
        run: |
          echo "‚ùå Failed to publish Multi-Cloud Cost Reports"
          echo "Check the workflow logs for details"

      - name: Create summary
        if: always()
        run: |
          echo "## Multi-Cloud Cost Reports Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.generate-and-deploy.result }}" == "success" ]; then
            echo "‚úÖ **Reports generated and deployed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä **Report Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "- Period: Last ${{ github.event.inputs.days_back || '30' }} days" >> $GITHUB_STEP_SUMMARY
            echo "- Type: ${{ github.event.inputs.report_type || 'both' }}" >> $GITHUB_STEP_SUMMARY
            echo "- Reports URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üåê **Multi-Cloud Reports:**" >> $GITHUB_STEP_SUMMARY
            echo "- AWS Cost Report (Public & Internal)" >> $GITHUB_STEP_SUMMARY
            echo "- Multi-Cloud Billing Report (AWS, Oracle, Google, IBM)" >> $GITHUB_STEP_SUMMARY
            echo "- Free Tier Value Analysis" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Report generation/deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
