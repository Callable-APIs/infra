---
- name: Update SSH keys on all nodes (non-destructive)
  hosts: all
  become: yes
  tasks:
    - name: Check if ansible user exists
      ansible.builtin.user:
        name: ansible
        state: present
      register: ansible_user_check

    - name: Create ansible user if it doesn't exist
      ansible.builtin.user:
        name: ansible
        shell: /bin/bash
        createhome: yes
        groups: "{{ 'wheel' if ansible_os_family == 'RedHat' else 'sudo' }}"
        append: yes
      when: not ansible_user_check.changed

    - name: Create .ssh directory for ansible user
      ansible.builtin.file:
        path: /home/ansible/.ssh
        state: directory
        owner: ansible
        group: ansible
        mode: '0700'

    - name: Update SSH authorized keys for ansible user
      ansible.builtin.copy:
        content: "{{ lookup('file', ssh_public_key_path) }}"
        dest: /home/ansible/.ssh/authorized_keys
        owner: ansible
        group: ansible
        mode: '0600'
      notify: restart ssh

    - name: Ensure ansible user has sudo access
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/ansible
        line: "ansible ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    # Container status check removed here; not needed for key rotation

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: "{{ 'sshd' if ansible_os_family == 'RedHat' else 'ssh' }}"
        state: restarted
      ignore_errors: yes

  vars:
    ssh_public_key_path: "{{ playbook_dir | dirname }}/artifacts/ssh/callableapis_rotated_public_key"
