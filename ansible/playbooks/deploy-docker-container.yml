---
- name: Deploy CallableAPIs Base Container using Docker
  hosts: all
  become: yes
  vars:
    container_name: "callableapis-base"
    container_image: "rl337/callableapis:base"
    container_port: 8080
    restart_policy: "unless-stopped"

  tasks:
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Fail if Docker is not installed
      ansible.builtin.fail:
        msg: "Docker is not installed. Please run the standardization playbook first."
      when: docker_check.rc != 0

    - name: Start Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: Wait for Docker to be ready
      ansible.builtin.wait_for:
        port: 2376 # Docker daemon port
        host: localhost
        timeout: 30
      ignore_errors: yes # Docker might use unix socket

    - name: Pull base container image
      ansible.builtin.docker_image:
        name: "{{ container_image }}"
        source: pull
        force_source: yes
      register: pull_result

    - name: Stop existing container if running
      ansible.builtin.docker_container:
        name: "{{ container_name }}"
        state: stopped
      ignore_errors: yes

    - name: Remove existing container if exists
      ansible.builtin.docker_container:
        name: "{{ container_name }}"
        state: absent
      ignore_errors: yes

    - name: Deploy base container
      ansible.builtin.docker_container:
        name: "{{ container_name }}"
        image: "{{ container_image }}"
        state: started
        restart_policy: "{{ restart_policy }}"
        ports:
          - "{{ container_port }}:{{ container_port }}"
        env:
          CONTAINER_VERSION: "{{ ansible_date_time.iso8601 }}"
        labels:
          app: "callableapis"
          service: "base"
          managed_by: "ansible"
          deployed_at: "{{ ansible_date_time.iso8601 }}"

    - name: Wait for container to start
      ansible.builtin.wait_for:
        port: "{{ container_port }}"
        host: localhost
        timeout: 30

    - name: Check container status
      ansible.builtin.docker_container_info:
        name: "{{ container_name }}"
      register: container_info

    - name: Test container health endpoint
      ansible.builtin.uri:
        url: "http://localhost:{{ container_port }}/health"
        method: GET
        status_code: 200
      register: health_check_result
      failed_when: false

    - name: Test container status endpoint
      ansible.builtin.uri:
        url: "http://localhost:{{ container_port }}/api/status"
        method: GET
        status_code: 200
      register: status_check_result
      failed_when: false

    - name: Display deployment results
      ansible.builtin.debug:
        msg: |
          Container deployment completed on {{ inventory_hostname }}
          Runtime: Docker
          Container: {{ container_info.container.Name }}
          Status: {{ container_info.container.State.Status }}
          Health endpoint: {{ 'PASSED' if health_check_result.status == 200 else 'FAILED' }}
          Status endpoint: {{ 'PASSED' if status_check_result.status == 200 else 'FAILED' }}
          Container port: {{ container_port }}
          Access URL: http://localhost:{{ container_port }}

    - name: Verify container is running
      ansible.builtin.docker_container_info:
        name: "{{ container_name }}"
      register: final_container_status

    - name: Display final container status
      ansible.builtin.debug:
        msg: |
          Final Container Status:
          - Name: {{ final_container_status.container.Name }}
          - Status: {{ final_container_status.container.State.Status }}
          - Started: {{ final_container_status.container.State.StartedAt }}
          - Image: {{ final_container_status.container.Config.Image }}
          - Ports: {{ final_container_status.container.NetworkSettings.Ports }}
