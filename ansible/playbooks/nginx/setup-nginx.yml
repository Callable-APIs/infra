---
- name: Setup Nginx Configuration
  hosts: webapp_hosts
  become: yes
  vars:
    nginx_ssl_dir: "/etc/nginx/ssl"
    ssl_cert_dir: "/etc/ssl/callableapis"

  tasks:
    - name: Install Nginx (Amazon Linux)
      ansible.builtin.shell: |
        if ! command -v nginx &> /dev/null; then
          # Use python3 explicitly for amazon-linux-extras
          if command -v python3 &> /dev/null && [ -f /usr/bin/amazon-linux-extras ]; then
            python3 /usr/bin/amazon-linux-extras install -y nginx1 || yum install -y nginx
          else
            yum install -y nginx || (yum install -y epel-release && yum install -y nginx)
          fi
        fi
      when: ansible_os_family == "RedHat"
      args:
        executable: /bin/bash
      failed_when: false
    
    - name: Install Nginx (Debian/Ubuntu)
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Create Nginx SSL directory
      ansible.builtin.file:
        path: "{{ nginx_ssl_dir }}"
        state: directory
        mode: "0755"
        owner: root
        group: root

    - name: Create SSL certificate symlinks
      ansible.builtin.file:
        src: "{{ ssl_cert_dir }}/{{ item.src }}"
        dest: "{{ nginx_ssl_dir }}/{{ item.dest }}"
        state: link
        force: yes
      loop:
        - { src: "privkey.pem", dest: "privkey.pem" }
        - { src: "cert.pem", dest: "cert.pem" }
        - { src: "fullchain.pem", dest: "fullchain.pem" }
        - { src: "chain.pem", dest: "chain.pem" }

    - name: Configure dynamic Nginx routing
      ansible.builtin.include_tasks: configure-routing-tasks.yml

    - name: Test Nginx configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      failed_when: false

    - name: Restart Nginx if configuration is valid
      ansible.builtin.systemd:
        name: nginx
        state: restarted
      when: nginx_test.rc == 0

    - name: Display Nginx setup results
      ansible.builtin.debug:
        msg: |
          Nginx Setup Results for {{ inventory_hostname }}:
          - SSL Directory: {{ nginx_ssl_dir }}
          - Configuration Test: {{ 'PASSED' if nginx_test.rc == 0 else 'FAILED' }}
          - Service Status: {{ 'RESTARTED' if nginx_test.rc == 0 else 'NOT RESTARTED' }}
          - Status: {{ 'SUCCESS' if nginx_test.rc == 0 else 'CONFIGURATION ERROR' }}
