---
- name: Minimal bootstrap for new nodes (install Python and basics)
  hosts: aws
  gather_facts: false
  become: yes
  tasks:
    - name: Install Python 3.10+ if not already installed (Amazon Linux 2)
      ansible.builtin.raw: |
        set -e
        # Check if python3.10 already exists
        if [ -f /usr/local/bin/python3.10 ] || [ -f /usr/bin/python3.10 ]; then
          echo "Python 3.10 already installed"
        elif command -v amazon-linux-extras >/dev/null 2>&1; then
          sudo amazon-linux-extras install -y python3.10 || true
        fi
        # Verify python3.10 is available
        if [ ! -f /usr/local/bin/python3.10 ] && [ ! -f /usr/bin/python3.10 ]; then
          echo "ERROR: python3.10 not found"
          exit 1
        fi

    - name: Symlink python -> python3.10 if needed
      ansible.builtin.raw: |
        set -e
        # Check both /usr/bin/python3.10 and /usr/local/bin/python3.10
        if [ -f /usr/local/bin/python3.10 ]; then
          sudo ln -sf /usr/local/bin/python3.10 /usr/bin/python3 || true
          sudo ln -sf /usr/local/bin/python3.10 /usr/bin/python || true
        elif [ -f /usr/bin/python3.10 ]; then
          sudo ln -sf /usr/bin/python3.10 /usr/bin/python3 || true
          sudo ln -sf /usr/bin/python3.10 /usr/bin/python || true
        elif command -v python3 >/dev/null 2>&1; then
          sudo ln -sf /usr/bin/python3 /usr/bin/python || true
        fi
      changed_when: false

    - name: Verify Python is available
      ansible.builtin.raw: python3 --version
      changed_when: false

    - name: Gather facts now that Python is present
      ansible.builtin.setup:


