---
- name: Deploy Cloudflare Origin Certificates to Nodes
  hosts: all # Deploy to all nodes
  become: yes
  vars:
    ssl_cert_dir: "/etc/ssl/callableapis"
    nginx_ssl_dir: "/etc/nginx/ssl"
    artifacts_dir: "{{ playbook_dir }}/../ansible/artifacts"

  tasks:
    - name: Check if SSL artifacts exist
      ansible.builtin.stat:
        path: "{{ artifacts_dir }}/ssl/{{ item }}"
      register: artifact_check
      loop:
        - privkey.pem
        - cert.pem
        - fullchain.pem
        - chain.pem

    - name: Fail if required SSL artifacts are missing
      ansible.builtin.fail:
        msg: |
          Required SSL artifacts are missing! Please run:
          1. ansible-playbook generate-cloudflare-origin-certificates.yml
          2. terraform apply -var-file=cloudflare-csr.tfvars -target=cloudflare_origin_ca_certificate.callableapis_origin_cert
          3. ansible-playbook retrieve-cloudflare-certificate.yml
      when: artifact_check.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

    - name: Create SSL certificate directory
      ansible.builtin.file:
        path: "{{ ssl_cert_dir }}"
        state: directory
        mode: "0755"

    - name: Create Nginx SSL directory
      ansible.builtin.file:
        path: "{{ nginx_ssl_dir }}"
        state: directory
        mode: "0755"

    - name: Copy private key from artifacts
      ansible.builtin.copy:
        src: "{{ artifacts_dir }}/ssl/privkey.pem"
        dest: "{{ ssl_cert_dir }}/privkey.pem"
        mode: "0600"
        owner: root
        group: root
        backup: yes

    - name: Copy certificate from artifacts
      ansible.builtin.copy:
        src: "{{ artifacts_dir }}/ssl/cert.pem"
        dest: "{{ ssl_cert_dir }}/cert.pem"
        mode: "0644"
        owner: root
        group: root
        backup: yes

    - name: Copy fullchain from artifacts
      ansible.builtin.copy:
        src: "{{ artifacts_dir }}/ssl/fullchain.pem"
        dest: "{{ ssl_cert_dir }}/fullchain.pem"
        mode: "0644"
        owner: root
        group: root
        backup: yes

    - name: Copy chain from artifacts
      ansible.builtin.copy:
        src: "{{ artifacts_dir }}/ssl/chain.pem"
        dest: "{{ ssl_cert_dir }}/chain.pem"
        mode: "0644"
        owner: root
        group: root
        backup: yes

    - name: Create symlinks for Nginx
      ansible.builtin.file:
        src: "{{ ssl_cert_dir }}/{{ item.src }}"
        dest: "{{ nginx_ssl_dir }}/{{ item.dest }}"
        state: link
        force: yes
      loop:
        - { src: "privkey.pem", dest: "privkey.pem" }
        - { src: "cert.pem", dest: "cert.pem" }
        - { src: "fullchain.pem", dest: "fullchain.pem" }
        - { src: "chain.pem", dest: "chain.pem" }

    - name: Verify SSL certificate files
      ansible.builtin.stat:
        path: "{{ ssl_cert_dir }}/{{ item }}"
      register: ssl_files
      loop:
        - "privkey.pem"
        - "cert.pem"
        - "fullchain.pem"
        - "chain.pem"

    - name: Display SSL certificate deployment results
      ansible.builtin.debug:
        msg: |
          SSL Certificate Deployment Results for {{ inventory_hostname }}:
          - SSL Directory: {{ ssl_cert_dir }}
          - Nginx SSL Directory: {{ nginx_ssl_dir }}
          - Files deployed: {{ ssl_files.results | map(attribute='stat.exists') | list }}
          - Status: {{ 'SUCCESS' if ssl_files.results | selectattr('stat.exists') | list | length == 4 else 'FAILED' }}
